const { test, expect } = require('@playwright/test');
require('dotenv').config();

let api;
let userId;
let postId;

const BASE_URL = process.env.GOREST_BASE_URL || 'https://gorest.co.in/public/v2';
const token = process.env.GOREST_TOKEN;

// Generate a unique email each run
function uniqueEmail() {
  return `pw_user_${Date.now()}_${Math.floor(Math.random() * 1000)}@example.com`;
}

test.describe('GoREST API - Users & Posts', () => {
  // ========================
  // BEFORE ALL
  // ========================
  test.beforeAll(async ({ playwright }) => {
    api = await playwright.request.newContext({
      baseURL: BASE_URL,
      extraHTTPHeaders: {
        Accept: 'application/json',
        Authorization: token ? `Bearer ${token}` : undefined
      }
    });
  });

  // ========================
  // AFTER ALL
  // ========================
  test.afterAll(async () => {
    await api.dispose();
  });

  // ========================
  // GET USERS
  // ========================
  test('GET /users', async () => {
    test.skip(!token, 'Token is required to fetch users');

    const res = await api.get('/users', {
      headers: { Authorization: `Bearer ${token}` },
      params: { page: 1, per_page: 5 }
    });

    if (res.status() !== 200) {
      console.log('GET /users failed, response:', await res.text());
    }

    expect(res.status()).toBe(200);

    const body = await res.json();
    expect(Array.isArray(body)).toBe(true);
  });

  // ========================
  // FULL CRUD LIFECYCLE
  // ========================
  test('Full CRUD lifecycle on /users', async () => {
    test.skip(!token, 'Token is required for create/update/delete');

    // CREATE USER
    const email = uniqueEmail();
    const createRes = await api.post('/users', {
      headers: { Authorization: `Bearer ${token}` },
      json: {
        name: 'Playwright User',
        email,
        gender: 'male',
        status: 'active'
      }
    });

    if (!createRes.ok()) {
      console.log('CREATE /users failed, response:', await createRes.text());
    }
    expect(createRes.status()).toBe(201);

    const newUser = await createRes.json();
    userId = newUser.id;

    // GET USER
    const getRes = await api.get(`/users/${userId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    expect(getRes.status()).toBe(200);

    // UPDATE USER
    const patchRes = await api.patch(`/users/${userId}`, {
      headers: { Authorization: `Bearer ${token}` },
      json: { name: 'Updated Name' }
    });

    const updatedUser = await patchRes.json();
    expect(updatedUser.name).toBe('Updated Name');

    // CREATE POST
    const postRes = await api.post('/posts', {
      headers: { Authorization: `Bearer ${token}` },
      json: {
        user_id: userId,
        title: 'Test Post',
        body: 'Generated by Playwright'
      }
    });

    expect(postRes.status()).toBe(201);
    const postObj = await postRes.json();
    postId = postObj.id;

    // DELETE POST
    const delPost = await api.delete(`/posts/${postId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    expect([200, 204]).toContain(delPost.status());

    // DELETE USER
    const delUser = await api.delete(`/users/${userId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    expect([200, 204]).toContain(delUser.status());
  });
});
